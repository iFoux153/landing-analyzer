<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Landing Analyzer</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0c0c0e;
      --surface: #141416;
      --border: #222226;
      --text: #f0f0f2;
      --muted: #888890;
      --accent: #7c6cfc;
      --green: #4ade80;
      --yellow: #fbbf24;
      --red: #f87171;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 16px 80px;
      line-height: 1.6;
    }

    .container { max-width: 720px; margin: 0 auto; }

    /* Header */
    .header { margin-bottom: 40px; }
    .header h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
    .header p { color: var(--muted); font-size: 0.9rem; }

    /* Input */
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 40px;
    }
    input[type="url"] {
      flex: 1;
      padding: 13px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s;
    }
    input[type="url"]:focus { border-color: var(--accent); }
    input[type="url"]::placeholder { color: #444; }

    .btn {
      padding: 13px 22px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.85; }
    .btn:disabled { opacity: 0.35; cursor: not-allowed; }

    /* Loader */
    .loader { display: none; padding: 60px 0; text-align: center; }
    .loader.active { display: block; }
    .spinner {
      width: 36px; height: 36px;
      border: 2.5px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader-step { color: var(--muted); font-size: 0.875rem; }

    /* Error */
    .error {
      display: none;
      background: #1c0a0a;
      border: 1px solid #5c1a1a;
      border-radius: 10px;
      padding: 14px 16px;
      color: #f87171;
      font-size: 0.875rem;
      margin-bottom: 24px;
    }
    .error.active { display: block; }

    /* Report */
    .report { display: none; }
    .report.active { display: block; }

    /* URL badge */
    .url-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--muted);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 4px 12px;
      margin-bottom: 24px;
      word-break: break-all;
    }

    /* Score hero */
    .score-hero {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 28px 24px;
      margin-bottom: 12px;
      display: flex;
      align-items: flex-start;
      gap: 24px;
    }
    .score-big {
      font-size: 3.5rem;
      font-weight: 800;
      line-height: 1;
      min-width: 90px;
      text-align: center;
    }
    .score-big span { font-size: 1.2rem; font-weight: 400; color: var(--muted); }
    .score-hero-right { flex: 1; }
    .score-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); margin-bottom: 8px; }
    .verdict-text { font-size: 0.925rem; color: #ccc; line-height: 1.65; }

    /* Section */
    .section { margin-top: 32px; }
    .section-title {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    /* Piliers grid */
    .piliers {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    @media (max-width: 500px) { .piliers { grid-template-columns: 1fr; } }

    .pilier-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pilier-name { font-size: 0.875rem; color: #ccc; }
    .pilier-score { font-size: 1rem; font-weight: 700; }
    .pilier-max { font-size: 0.75rem; font-weight: 400; color: var(--muted); }

    /* Probl√®mes */
    .problem {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 3px solid var(--red);
      border-radius: 10px;
      padding: 18px 20px;
      margin-bottom: 10px;
    }
    .problem-num {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--red);
      margin-bottom: 6px;
    }
    .problem-title { font-size: 1rem; font-weight: 700; margin-bottom: 10px; }
    .problem-body { font-size: 0.875rem; color: #bbb; line-height: 1.65; margin-bottom: 10px; }
    .problem-action {
      font-size: 0.875rem;
      color: var(--accent);
      line-height: 1.65;
      padding-left: 12px;
      border-left: 2px solid var(--accent);
    }

    /* Reformulation */
    .reform {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .reform-row {
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .reform-row + .reform-row { border-top: 1px solid var(--border); }
    .reform-tag {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }
    .reform-before { font-size: 0.9rem; color: #666; text-decoration: line-through; }
    .reform-after { font-size: 0.95rem; font-weight: 600; color: var(--green); }
    .reform-why { font-size: 0.875rem; color: #bbb; line-height: 1.65; }

    /* Version am√©lior√©e */
    .improved-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .improved-block {
      padding: 18px 20px;
    }
    .improved-block + .improved-block { border-top: 1px solid var(--border); }
    .improved-block-title {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .diff-row { margin-bottom: 8px; }
    .diff-label { font-size: 0.7rem; color: var(--muted); margin-bottom: 2px; }
    .diff-old { font-size: 0.875rem; color: #666; text-decoration: line-through; line-height: 1.55; }
    .diff-new { font-size: 0.875rem; color: var(--green); line-height: 1.55; margin-top: 6px; }

    .loader-improved {
      padding: 24px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--muted);
      font-size: 0.875rem;
    }
    .spinner-sm {
      width: 18px; height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }

    @media (max-width: 500px) {
      .score-hero { flex-direction: column; gap: 16px; }
      .search-box { flex-direction: column; }
    }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>üîç Landing Analyzer</h1>
    <p>Audit CRO de ta landing page ‚Äî score, probl√®mes et version am√©lior√©e.</p>
  </div>

  <div class="search-box">
    <input type="url" id="urlInput" placeholder="https://exemple.com" autocomplete="off"/>
    <button class="btn" id="analyzeBtn" onclick="analyze()">Analyser</button>
  </div>

  <div class="error" id="errorBox"></div>
  <div class="loader" id="loader">
    <div class="spinner"></div>
    <div class="loader-step" id="loaderStep">Chargement de la page...</div>
  </div>

  <div class="report" id="report">

    <div class="url-badge">üåê <span id="reportUrl"></span></div>

    <!-- Score global -->
    <div class="score-hero">
      <div>
        <div class="score-big" id="scoreNum">‚Äî<span>/100</span></div>
      </div>
      <div class="score-hero-right">
        <div class="score-label">Verdict</div>
        <div class="verdict-text" id="verdictText"></div>
      </div>
    </div>

    <!-- Piliers -->
    <div class="section">
      <div class="section-title">Scores par pilier</div>
      <div class="piliers" id="piliersGrid"></div>
    </div>

    <!-- Probl√®mes -->
    <div class="section">
      <div class="section-title">Top 3 probl√®mes critiques</div>
      <div id="problemsList"></div>
    </div>

    <!-- Reformulation -->
    <div class="section">
      <div class="section-title">Reformulation du titre</div>
      <div class="reform" id="reformCard"></div>
    </div>

    <!-- Version am√©lior√©e -->
    <div class="section">
      <div class="section-title">Version am√©lior√©e ‚ú®</div>
      <div class="improved-section" id="improvedSection">
        <div class="loader-improved" id="loaderImproved">
          <div class="spinner-sm"></div>
          <span>Claude r√©dige les sections am√©lior√©es...</span>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const PILIERS = [
  { key: 'clarte_message',     label: 'Clart√© du message',     max: 20 },
  { key: 'proposition_valeur', label: 'Proposition de valeur', max: 20 },
  { key: 'copywriting',        label: 'Copywriting',           max: 15 },
  { key: 'structure_flow',     label: 'Structure & flow',      max: 15 },
  { key: 'call_to_action',     label: 'Call to Action',        max: 15 },
  { key: 'confiance_preuve',   label: 'Confiance & preuves',   max: 10 },
  { key: 'mobile_performance', label: 'Mobile & performance',  max: 5  },
];

function scoreColor(val, max) {
  const pct = val / max;
  if (pct >= 0.75) return 'var(--green)';
  if (pct >= 0.50) return 'var(--yellow)';
  return 'var(--red)';
}

const steps = [
  'Chargement de la page...',
  'Extraction du contenu...',
  'Analyse CRO en cours...',
  'Calcul des scores...'
];

async function analyze() {
  const rawUrl = document.getElementById('urlInput').value.trim();
  if (!rawUrl) return;

  let url = rawUrl;
  if (!url.startsWith('http://') && !url.startsWith('https://')) {
    url = 'https://' + url;
    document.getElementById('urlInput').value = url;
  }

  const btn = document.getElementById('analyzeBtn');
  const loader = document.getElementById('loader');
  const report = document.getElementById('report');
  const errorBox = document.getElementById('errorBox');

  btn.disabled = true;
  loader.classList.add('active');
  report.classList.remove('active');
  errorBox.classList.remove('active');

  let stepIdx = 0;
  const stepEl = document.getElementById('loaderStep');
  const interval = setInterval(() => {
    stepIdx = (stepIdx + 1) % steps.length;
    stepEl.textContent = steps[stepIdx];
  }, 2500);

  try {
    const res = await fetch('/api/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });
    const data = await res.json();
    clearInterval(interval);

    if (!data.success) throw new Error(data.error);

    loader.classList.remove('active');
    renderReport(url, data.analysis);
    report.classList.add('active');

    // Lancer la version am√©lior√©e en async
    loadImproved(url, data.analysis);

  } catch (err) {
    clearInterval(interval);
    loader.classList.remove('active');
    errorBox.textContent = '‚ùå ' + (err.message || 'Erreur inattendue.');
    errorBox.classList.add('active');
  } finally {
    btn.disabled = false;
  }
}

function renderReport(url, a) {
  document.getElementById('reportUrl').textContent = url;

  // Score global
  const color = scoreColor(a.score_global, 100);
  const scoreEl = document.getElementById('scoreNum');
  scoreEl.innerHTML = `<span style="color:${color}">${a.score_global}</span><span style="font-size:1.2rem;font-weight:400;color:var(--muted)">/100</span>`;
  document.getElementById('verdictText').textContent = a.verdict_global;

  // Piliers
  document.getElementById('piliersGrid').innerHTML = PILIERS.map(p => {
    const val = a.scores[p.key] || 0;
    const c = scoreColor(val, p.max);
    return `
      <div class="pilier-card">
        <span class="pilier-name">${p.label}</span>
        <span class="pilier-score" style="color:${c}">${val}<span class="pilier-max">/${p.max}</span></span>
      </div>`;
  }).join('');

  // Probl√®mes
  document.getElementById('problemsList').innerHTML = a.top3_problemes.map((p, i) => `
    <div class="problem">
      <div class="problem-num">Probl√®me ${i + 1}</div>
      <div class="problem-title">${p.titre}</div>
      <div class="problem-body">${p.constat}</div>
      <div class="problem-action">${p.action}</div>
    </div>`).join('');

  // Reformulation
  const r = a.reformulation;
  document.getElementById('reformCard').innerHTML = `
    <div class="reform-row">
      <div class="reform-tag">Titre actuel</div>
      <div class="reform-before">${r.titre_actuel}</div>
    </div>
    <div class="reform-row">
      <div class="reform-tag">Titre sugg√©r√©</div>
      <div class="reform-after">${r.titre_suggere}</div>
    </div>
    <div class="reform-row">
      <div class="reform-tag">Pourquoi</div>
      <div class="reform-why">${r.pourquoi}</div>
    </div>`;
}

async function loadImproved(url, analysis) {
  try {
    const res = await fetch('/api/improve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url, analysis })
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    renderImproved(data.improved);
  } catch (err) {
    document.getElementById('improvedSection').innerHTML = `
      <div style="padding:20px;color:var(--muted);font-size:0.875rem;">
        Impossible de g√©n√©rer la version am√©lior√©e : ${err.message}
      </div>`;
  }
}

function renderImproved(improved) {
  const container = document.getElementById('improvedSection');
  container.innerHTML = improved.sections.map(s => `
    <div class="improved-block">
      <div class="improved-block-title">${s.section}</div>
      <div class="diff-row">
        <div class="diff-label">Actuel</div>
        <div class="diff-old">${s.original}</div>
      </div>
      <div class="diff-row">
        <div class="diff-label">Suggestion</div>
        <div class="diff-new">${s.improved}</div>
      </div>
      ${s.note ? `<div style="font-size:0.8rem;color:var(--muted);margin-top:8px">${s.note}</div>` : ''}
    </div>`).join('');
}

document.getElementById('urlInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') analyze();
});
</script>
</body>
</html>
